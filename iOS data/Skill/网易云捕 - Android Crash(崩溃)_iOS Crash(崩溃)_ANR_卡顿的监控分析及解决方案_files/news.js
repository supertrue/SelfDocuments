define(["jquery","apkpack/utils/renderUtils"],function(e,t){var a={},n={news:0,skill:1};return a.render=function(){e(".content").removeClass("visible");var n=e(".content.news").addClass("visible");t.common.showLoading(n),requirejs(["text!../html/news.html","doT","moment"],function(s,i,l){n.html(s);var r=a.parseUrl();if(r&&r.newsId)e("#newsDetailContainer").removeClass("hidden"),e.ajax("news/id.do?id="+r.newsId).then(function(t){if(t&&t.success){var a=i.template(e("#newsCtnTpl").text()),n=t.data||{};n.createDate=l(t.data.insertTime).format("YYYY-MM-DD"),n.newsType=0===t.data.type?"news":"skill",e("#newsDetailContainer .news-detail").removeClass("loading").html(a(n)),e("pre code").each(function(e,t){hljs.highlightBlock(t)})}});else{var d=r&&r.newsType||"news";e("#newsListContainer").removeClass("hidden").find("li[data-tab-index="+d+"]").addClass("act"),a.renderNewsList(d)}t.common.hideLoading(n),a.listener()})},a.renderNewsList=function(t){var a=e("#newsListContainer").find(".tvbd li.act input.current-page").val()||1,s=10,i=t||"news",l={newsList:[],page:isNaN(parseInt(a))?1:parseInt(a),totalPage:1,newsType:i},r={offset:(a-1)*s,limit:s,type:n[i]};requirejs(["doT","moment"],function(t,a){e.when(e.ajax("news/list.do",{data:{queryNewsInfo:JSON.stringify(r)}}).then(function(e){if(e&&e.success){var t=e.data&&e.data.rows||[];t.forEach(function(e,n){t[n].createDate=a(e.insertTime).format("YYYY-MM-DD")}),l.newsList=t}}),e.ajax("news/count.do",{data:{queryNewsInfo:JSON.stringify({type:r.type})}}).then(function(e){if(e&&e.success===!0){var t=e.data&&e.data.count||0;l.totalPage=Math.ceil(t/s)}})).then(function(){var a=t.template(e("#newsListTpl").text());e("#newsListContainer .tvbd > ul > li").removeClass("act"),e("#newsListContainer .tvbd > ul > li."+i).addClass("act").removeClass("loading").html(a(l))},function(){e("#newsListContainer .tvbd > ul > li").removeClass("act"),e("#newsListContainer .tvbd > ul > li."+i).removeClass("loading").html("<table class='news-list-table'><tr><td class='news-title'>网络错误，请稍候重试……</td></tr></table>")})})},a.parseUrl=function(){var e=location.hash,t=e.match(/!newsId=(\d*)/),a=e.match(/!newsType=(news|skill)/),n={};return t&&(n.newsId=t[1]),a&&(n.newsType=a[1]),n},a.listener=function(){var t=e(".content.news").off();t.on("click",".tvhd li",function(){var t=e(this);t.parents("ul").find("li").removeClass("act"),t.addClass("act");var n=t.parents(".m-tabview").find(".tvbd>ul");n.find("li").removeClass("act"),n.find("li."+t.data("tabIndex")).addClass("act").html("").addClass("loading"),a.renderNewsList(t.data("tabIndex"))}).on("click",".m-paginator a.prev, .m-paginator a.next",function(){var t=e(this);e(this).attr("disabled")||(e(".news-list-table").html("").addClass("loading"),t.parent().find("input.current-page").val(t.data().page),a.renderNewsList(e("#newsListContainer .tvhd li.act").data("tabIndex")))}).on("blur keydown",".m-paginator input.current-page",function(t){if("focusout"===t.type||"keydown"===t.type&&13===t.keyCode){e(".news-list-table").html("").addClass("loading");var n=e(this),s=parseInt(n.val()),i=n.parent().find(".total-page").data().totalPage;s=isNaN(s)||1>s?1:s>i?i:s,n.val(s),a.renderNewsList(e("#newsListContainer .tvhd li.act").data("tabIndex"))}})},a});