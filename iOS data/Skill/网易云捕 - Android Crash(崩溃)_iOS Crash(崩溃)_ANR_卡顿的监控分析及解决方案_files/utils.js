define(["jquery"],function(e){function t(){this.createHash=function(t){return t===window.location.hash?void e(window).trigger("hashchange"):(t.startsWith("#")&&(t=t.substr(1)),void(window.location.hash="#"+t))},this.showRightSideBtns=function(){e(window).width()>720&&e(".g-rside").attr("style","").fadeIn(800)},this.hideRightSideBtns=function(){e(".g-rside").hide()},this.showMask=function(){var t=document.body.scrollWidth,n=document.body.scrollHeight;e(".m-mask").css({height:n,width:t}).fadeIn()},this.hideMask=function(){e(".m-mask").fadeOut()},this.hideDialog=function(){e(".m-mask, .m-dialog").fadeOut(200)},this.upload=function(t,n,r){var a=t.find("input[type=file]").get(0),o=t.attr("action"),i=a&&a.files||r&&r.files;if(e.isFunction(n)&&(n={uploadCb:n}),i&&window.FormData){var s=new FormData(t.get(0)),c=r&&r.files;if(c&&c.length>0)for(var p=0;p<c.length;p++)s.append(r.name,c[p]);e.ajax(o,{type:"POST",processData:!1,contentType:!1,data:s,xhr:function(){var t=new window.XMLHttpRequest;return n.progressCb&&e.isFunction(n.progressCb)&&(t.upload.addEventListener("progress",n.progressCb,!1),t.addEventListener("progress",n.progressCb,!1)),t}}).then(n.uploadCb,n.uploadCb)}else{var l=Math.floor(1e5*Math.random()),d="uploader-frame-"+l,u="uploader-cb-"+l,h=e('<iframe id="'+d+'" name="'+d+'" class="hidden">');window[u]=function(e){console.log("received callback:",e),n.uploadCb(JSON.parse(e)),h.remove(),window[u]=void 0},t.attr("target",d).append(h).attr("action",o+"?callback="+u).trigger("submit")}},this.getCookie=function(e){for(var t=encodeURIComponent(e)+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var a=n[r];" "===a.charAt(0);)a=a.substring(1,a.length);if(0===a.indexOf(t))return decodeURIComponent(a.substring(t.length,a.length))}return null},this.setCookie=function(e,t,n){var r;if(n){var a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3),r="; expires="+a.toGMTString()}else r="";document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+r+"; path=/"},this.eraseCookie=function(e){this.setCookie(e,"",-1)},this.goLogin=function(){e(".login-container > a#loginButton").click()},this.goTop=function(){var t=e(".doc > .header");e("html, body").animate({scrollTop:t.offset().top},500)},this.niceAlert=function(t){var n=this;requirejs(["doT"],function(r){function a(e){o.hide().off(),e===!0&&n.hideMask()}var o=e(".niceAlert");o.length>0&&o.off().remove();var i={str:{title:"注意",alertContent:"",subContent:""},btns:{ok:!0,okStr:"",cancel:!1,cancelStr:"",close:!1},callback:{ok:void 0,cancel:void 0},hideMask:!0};e.isPlainObject(t)?e.extend(!0,i,t):i.str.alertContent=t;var s=e("#niceAlertTpl").text(),c=r.template(s);e("body").append(c(i)),n.showMask(),o=e(".niceAlert"),o.removeClass("hidden").show().get(0).scrollIntoView(),o.on("click",".btn-ok",function(t){i.callback.ok&&e.isFunction(i.callback.ok)&&i.callback.ok(t),a(i.hideMask)}).on("click",".btn-cancel",function(t){i.callback.cancel&&e.isFunction(i.callback.cancel)&&i.callback.cancel(t),a(i.hideMask)}).on("click",".dlclose",function(){a(i.hideMask)})})},this.showAjaxError=function(e,t){var n={str:{alertContent:"一定是点击姿势不对，请您换个姿势再点击"},hideMask:t!==!1};e&&!e.success&&e.msg?(n.str.alertContent=e.msg,this.niceAlert(n)):this.niceAlert(n)},this.parseDumplyParam=function(){var e=decodeURIComponent(location.hash).split("/");if(!location.hash||e.length<4)return{};var t=e[3].substring(1).split("&"),n={};return t.forEach(function(e,t){var r=e.split("=");2==r.length?n[r[0].trim()]=r[1].trim():n[r[0].trim()]=r[0].trim()}),n.appId=n.id,n.id=n.crashTypeId,n.version=n.version?decodeURIComponent(n.version):"",n},this.isDemoApp=function(e){var t=!1,n=MAS.User.demoList,r=Object.prototype.toString.call(e);return"[object String]"===r?n.forEach(function(n){n.appId===e&&(t=!0)}):"[object Object]"===r&&n.forEach(function(n){e&&e.appId==n.appId&&(t=!0)}),t},this.getAppList=function(){var t=this,n=this.parseDumplyParam()||{},r=MAS.User.demoList,a=!("true"===n.all)&&(t.isDemoApp(n.appId)||!n.appId&&t.isDemoApp(MAS.User.currentApp));return a?e.when(r):e.ajax("app/querymyapplist.do").then(function(e){return e&&e.success?e.data&&e.data.list||[]:void 0},function(){})},this.setLastApp=function(e,t){var n=this,r=n.getUserSettings("lastAppInfo");return e.appId?(t.forEach(function(t){e.appId==t.appId&&(MAS.User.currentApp=t,n.setUserSettings(t,"lastAppInfo"))}),MAS.User.currentApp&&n.isValidApp(e.appId,t)?MAS.User.currentApp:void(t.length>0?(n.niceAlert("您没有查看当前app数据的权限, 自动为您跳转到您的默认app"),r=r?r:t[0],this.createHash("#dumply/crashLog/crash/#id="+r.appId)):(n.niceAlert("您没有查看当前app数据的权限, 也没有创建或加入任何app，请先创建APP"),this.createHash("#userCenter/addApp")))):("true"==e.all&&n.isDemoApp(MAS.User.currentApp)?MAS.User.currentApp=t[0]:MAS.User.currentApp&&!n.isValidApp(MAS.User.currentApp.appId,t)?MAS.User.currentApp=t[0]:MAS.User.currentApp=MAS.User.currentApp||r||t[0],MAS.User.currentApp)},this.getCurrentUser=function(){var t=[{creator:"system",createTime:1447654321e3,appName:"Demo - Android",appId:"A001099276",logo:"../image/newStyle/defaultAppIcon.png",os:"android",memberNum:"1",type:0,subType:3,role:1},{creator:"system",createTime:1447654321e3,appName:"Demo - iOS",appId:"I000661365",logo:"../image/newStyle/defaultAppIcon.png",os:"ios",memberNum:"1",type:0,subType:3,role:1}],n={demoList:t,demoApp:t[0],role:2,csrf:""};if(e(".login-container").length>0)return this.eraseCookie("lastAccessTime"),n;var r=this.getCookie("lastAccessTime");return r&&(r=r.replace(/"/g,"").split("|"),n.name=e(".m-login span a").text()||"",n.account=r[0],n.role=r[2]||2,n.csrf=r[3]||"",n.email=r[4]&&"@"!==r[4]?r[4]:"",n.appList=[]),n},this.drawLineChart=function(t,n,r,a){requirejs(["echarts","echarts-theme"],function(o,i){var s=o.init(t,i);s.showLoading(),e.ajax(n,r).then(function(e){var t=[],n=[],o=e.data,i={};switch(r.data.time){case"hour":i={interval:5};break;case"day":i={interval:0};break;case"twoDays":i={interval:2};break;case"threeDays":i={interval:0};break;case"week":i={interval:0};break;case"month":i={interval:3};break;default:i={interval:"auto"}}for(var c=o.y,p=0,l=c.length;l>p;p++){var d=c[p];t.push({name:d.version,type:"line",data:d.data}),n.push(d.version)}var u={tooltip:{trigger:"axis",formatter:a&&a.tooltipFormatter||null,axisPointer:{lineStyle:{color:"#2398fa"}}},legend:{show:a&&a.showLegend||!1,data:n,bottom:"0px"},xAxis:{type:"category",boundaryGap:!1,splitLine:!1,data:o.x,axisLabel:i},yAxis:{type:"value",axisLabel:{formatter:function(e,t){return e>=1e6?e/1e6+"M":e>=1e4?e/1e3+"K":e}}},series:t};s.setOption(u),s.hideLoading()})})},this.throttle=function(e,t){var n=null;return function(){var r=this,a=arguments;n&&clearTimeout(n),n=setTimeout(function(){e.apply(r,a)},t)}},this.setUserSettings=function(t,n){var r=MAS.User.currentApp.appId,a=MAS.User.account;if(!this.isDemoApp(r)||"lastAppInfo"!==n){var o={lastAppInfo:MAS.User.currentApp,crash:{version:"",time:"twoMonths",sdkType:"",exceptionType:"",isDone:"-1",orderBy:"lastReportTime",orderType:"desc"},anr:{version:"",time:"twoMonths",isSysAnr:"-1",isFixed:"-1",orderBy:"lastReportTime",orderType:"desc"}},i="lastAppInfo"===n?n+a:n+r+a,s=JSON.parse(localStorage.getItem(i)),c=e.extend(!0,{},o[n],s,t);localStorage.setItem(i,JSON.stringify(c))}},this.isValidApp=function(e,t){var n=!1;return t.forEach(function(t){t.appId===e&&(n=!0)}),n},this.getUserSettings=function(e){var t="lastAppInfo"===e?e+MAS.User.account:e+MAS.User.currentApp.appId+MAS.User.account,n=JSON.parse(localStorage.getItem(t));if(!n){var r={lastAppInfo:MAS.User.currentApp,crash:{version:"",time:"twoMonths",sdkType:"",exceptionType:"",isDone:"-1",orderBy:"lastReportTime",orderType:"desc"},anr:{version:"",time:"twoMonths",isSysAnr:"-1",isFixed:"-1",orderBy:"lastReportTime",orderType:"desc"}};n=r[e]}return"lastAppInfo"===e&&n&&!this.isValidApp(n.appId,MAS.User.appList)&&(localStorage.removeItem(t),n=MAS.User.appList[0]),n},this.cursLogin=function(){if(!(e("#C-URS-LOGIN:visible").length>0)){var t=null,n={autoReg:1,defaultRegType:"2",regText:"没有帐号？免费注册",loginCallBack:function(n){console.dir(n),e.ajax("/user/yunLogin.do").then(function(n){if(n&&n.success){t.destroy();var r="/#userCenter";n.data&&n.data.isbind===!1&&(r+="/#!comfirmBindEmail=true"),MAS.User.account="cursLoginSuccess",location.replace(r),location.reload()}else e("#C-URS-LOGIN").find(".curs-m-pop").html('<i class="curs-i"></i><span class="curs-u-info">'+n.msg+"</span>")})},closeCallBack:function(e){t.destroy(),(location.hash.indexOf("#userCenter")>=0||location.hash.indexOf("#dumply/solution/input")>=0)&&(location.href="/")}},r=location.host;r.indexOf("crash.163.com")>=0?(n.pd="crash",n.pkid="RMADhVc",n.pkht="crash.163.com"):r.indexOf(".163yun.com")>=0?(n.pd="crash",n.pkid="cjclxoF",n.pkht="crash.163yun.com"):(n.pd="crashtest",n.pkid="Hmvtrys",n.pkht="bug.aq.163.com");var a=function(){try{t=new CURS(n),t.show(),o()}catch(e){console.log(e)}},o=function(){e(".xx-curs-m-check").addClass("f-cb").append('<span class="tmp-acc-upgrade f-fr"><a href="/#news/!newsId=26" class="f-fr" target="_blank">帐号升级公告</a></span>')};CURS_MSG.getJs(a)}}}return new t});