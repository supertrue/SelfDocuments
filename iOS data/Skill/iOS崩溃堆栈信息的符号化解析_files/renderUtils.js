define(["jquery","doT","apkpack/utils/utils"],function(t,e,a){var n={common:{},dumply:{}};return n.common.showLoading=function(t){t.addClass("loading")},n.common.hideLoading=function(t){t.removeClass("loading")},n.common.setHeader=function(e){var a=t(".doc > .header");if(!a.hasClass(e)){var n=a.find(".top");switch(e){case"index":n.find("i.arr").removeClass("default"),a.attr("class","header index"),a.prev("#cursTopNav").addClass("show");break;case"feature":a.find(".title h3").text("Crash 捕捉的重要性"),a.find(".title p").text("您是否遇到上线的APP有此类用户评论？是否因此而烦恼？"),a.attr("class","header feature"),a.prev("#cursTopNav").removeClass("show");break;case"wide":n.find("i.arr").addClass("default"),a.attr("class","header wide"),a.prev("#cursTopNav").removeClass("show");break;case"default":default:n.find("i.arr").addClass("default"),a.attr("class","header default"),a.prev("#cursTopNav").removeClass("show")}}},n.common.showContent=function(e){return t(".content").removeClass("visible"),t(".content."+e).addClass("visible")},n.dumply.showTips=function(a){MAS.Dumply&&MAS.Dumply.tipInterval&&clearInterval(MAS.Dumply.tipInterval),t.ajax("tip/query.do",{type:"POST",data:{data:JSON.stringify({appId:MAS.User.currentApp.appId})}}).then(function(n){if(n&&n.success===!0){var i=n.data&&n.data.tipList||[];if(0===i.length)return;var r=0,s=i[r],o=s.url?"<a href='{{=it.url}}'>{{!it.tip}}</a>":"{{!it.tip}}",d=e.template(o);t(".dumply.content:visible .tip .tip-content").fadeOut(function(){t(this).html(d(s)).fadeIn()}),MAS.Dumply.tipInterval=setInterval(function(){r=(r+1)%i.length;var a=i[r],n=a.url?"<a href='{{=it.url}}'>{{!it.tip}}</a>":"{{!it.tip}}",s=e.template(n);t(".dumply.content:visible .tip .tip-content").fadeOut(function(){t(this).html(s(a)).fadeIn()})},a)}})},n.dumply.showDumpList=function(n){var i=t(".m-pagecount").find("input").val()||1,r=20;i=0==i?1:i;var s=t("#dumpList th.order[data-order=true]").data(),o=a.getUserSettings("crash"),d={appId:t(".dashhd").find(".app").data().appId,version:t("#appVersionSelector").val(),time:t("#crashTime").val(),isDone:t("#isDone").val(),sdkType:t("#crashType").val(),exceptionType:t("#exceptionType").val(),offset:(i-1)*r,limit:r,orderType:s&&s.orderType||o.orderType,orderBy:s&&s.orderBy||o.orderBy};t("#dumpList").html("载入中，请稍候"),require(["text!../html/dumply/dumpList.html","moment"],function(a,s){n&&(d[n.type]=n.content);var o={type:"POST",data:{queryCrashType:JSON.stringify(d)}},p={list:[],page:1,pageNum:0,orderType:d.orderType,orderBy:d.orderBy},l=e.template(a);t.when(t.ajax("crash/getcrashtypelist.do",o).then(function(t){t&&t.success&&t.data&&(p.list=t.data.list||[],p.page=i,p.list.forEach(function(t,e){p.list[e].firstReportTime=s(t.firstReportTime).format("YYYY-MM-DD HH:mm:ss"),p.list[e].lastReportTime=s(t.lastReportTime).format("YYYY-MM-DD HH:mm:ss")}))}),t.ajax("crash/getcrashtypecount.do",o).then(function(t){if(t&&t.success&&t.data){var e=t.data.count;p.pageNum=Math.ceil(e/r)||0,p.totalNum=e}})).then(function(){if(t("#dumpList").html(l(p)),0===p.list.length)t("#searchGroup").find("input.hidden").each(function(e,a){var n=t(a);if(n.val()!=n.data("defaultVal")){t("td[colspan=5]").text("未找到相关数据，请更改筛选条件以重新搜索");var i=n.parents(".m-select3");i.addClass("shadow-blink"),setTimeout(function(){i.removeClass("shadow-blink")},3600)}});else{var e=[];p.list.forEach(function(t){var a={id:t.id,exceptionName:t.logTitle};e.push(a)});var a={type:"POST",data:{exceptionSolution:JSON.stringify({exceptionType:e,appId:d.appId,type:"crash"})}};t.ajax("solution/has.do",a).then(function(e){e&&e.success&&e.data&&e.data.list.forEach(function(e){var a="[data-crash-type-id="+e.exceptionTypeId+"]",n=t(a).next().find(".tag-list");if(e.hasSolution===!0&&0===n.find("span.tag.has-solution").length){var i="/#dumply/solution/read/#!type=crash&exceptionTypeId="+e.exceptionTypeId+"&appId="+d.appId;n.append("<span class='tag has-solution' data-href='"+i+"'>匹配到解决方案</span>")}})})}},function(){t("#dumpList").html("载入失败，请稍后重试")})})},n.dumply.showAnrList=function(n){var i=t(".m-pagecount").find("input").val()||1,r=20;i=0>=i?1:i;var s=t("#anrList"),o=s.find("th.order[data-order=true]").data(),d=a.getUserSettings("anr"),p={appId:t(".dashhd").find(".app").data().appId,version:t("#appVersionSelector").val(),time:t("#anrTime").val(),isFixed:t("#isFixed").val(),offset:(i-1)*r,limit:r,orderType:o&&o.orderType||d.orderType,orderBy:o&&o.orderBy||d.orderBy};s.addClass("loading"),require(["text!../html/dumply/anrList.html","moment"],function(a,o){n&&(p[n.type]=n.content);var d={type:"POST",data:{queryAnrType:JSON.stringify(p)}},l={list:[],page:1,pageNum:0,orderType:p.orderType,orderBy:p.orderBy},c=e.template(a);t.when(t.ajax("anr/getTypeList.do",d).then(function(t){t&&t.success&&t.data&&(l.list=t.data.list||[],l.page=i,l.list.forEach(function(t,e){l.list[e].firstReportTime=o(t.firstReportTime).format("YYYY-MM-DD HH:mm:ss"),l.list[e].lastReportTime=o(t.lastReportTime).format("YYYY-MM-DD HH:mm:ss")}))}),t.ajax("anr/getTypeCount.do",d).then(function(t){if(t&&t.success&&t.data){var e=t.data.count;l.pageNum=Math.ceil(e/r)||0,l.totalNum=e}})).then(function(){if(s.html(c(l)).removeClass("loading"),0===l.list.length)t("#anrSearchGroup").find("input.hidden").each(function(e,a){var n=t(a);if(n.val()!=n.data("defaultVal")){t("td[colspan=5]").text("未找到相关数据，请更改筛选条件以重新搜索");var i=n.parents(".m-select3");i.addClass("shadow-blink"),setTimeout(function(){i.removeClass("shadow-blink")},3600)}});else{var e=[];l.list.forEach(function(t){var a={id:t.id,exceptionName:t.exceptionName};e.push(a)});var a={type:"POST",data:{exceptionSolution:JSON.stringify({exceptionType:e,appId:p.appId,type:"anr"})}};t.ajax("solution/has.do",a).then(function(e){e&&e.success&&e.data&&e.data.list.forEach(function(e){var a="[data-type-id="+e.exceptionTypeId+"]",n=t(a).next().find(".tag-list");if(e.hasSolution===!0&&0===n.find("span.tag.has-solution").length){var i="/#dumply/solution/read/#!type=anr&exceptionTypeId="+e.exceptionTypeId+"&appId="+p.appId;n.append("<span class='tag has-solution' data-href='"+i+"'>匹配到解决方案</span>")}})})}},function(){s.html("载入失败，请稍后重试").removeClass("loading")})})},n.dumply.showRecentCrash=function(n){var i=n.offset||0==n.offset?"crash/getrecentlycrashdetail.do":"crash/getrecentlycrashdetailbyid.do";t.ajax(i,{type:"POST",data:{queryCrashInfo:JSON.stringify(n)}}).then(function(i){i&&i.success?requirejs(["moment"],function(a){var r=i.data.object;for(var s in r)if(r.hasOwnProperty(s)){var o=r[s];"crashTime"!=s&&"startTime"!=s||(o=a(o).format("YYYY-MM-DD HH:mm:ss")),t("#crash_"+s).text(o)}"iPhone OS"!==r.os&&"watchOS"!==r.os||(t(".ios-modify-IMEI").text("设备 ID"),t(".ios-modify-SD").text("磁盘可用占比"),t("#crash_imei").hide(),t("#crash_availSdSize").parent().hide(),t("div.tvhd.crash-detail > ul > li[data-tab-index=sys-log]").hide(),t("div.tvhd.crash-detail > ul > li[data-tab-index=user-param]").text("其它信息"));var d=t("#dumpStackTpl").text(),p=r.logContent&&r.logContent.split("\n")||[],l=r.userLog&&r.userLog.split("\n")||[],c=r.userParam&&r.userParam.split("\n")||[],u=r.sysLog&&r.sysLog.split("\n")||[],m=r.threadInfo&&r.threadInfo.split("\n")||[],h=e.template(d);t("#dumpStackFull").html(h(p)),t("#userLogList").html(h(l)),t("#userParamList").html(h(c)),t("#sysLogList").html(h(u)),t("#threadInfoList").html(h(m)),t("div.panelbd").removeClass("loading");var f={data:{exceptionSolution:JSON.stringify({exceptionTypeId:t("[data-crash-type-id]").data("crashTypeId"),appId:n.appId,type:"crash"})}};t.ajax("solution/count.do",f).then(function(e){if(e&&e.success){var a=e.data.count||0,i=a>0?a+"条解决方案":"我有解决方案",r="#dumply/solution/"+(a>0?"read":"input")+"/#!type=crash&exceptionTypeId="+t("[data-crash-type-id]").data("crashTypeId")+"&offset="+n.offset+"&appId="+MAS.User.currentApp.appId;t("#dumpDetailCtn").find("a.btn-solution").text(i).attr("href",r).removeClass("hidden").toggleClass("offer-solution",0>=a)}})}):(a.showAjaxError(i),t("div.panelbd").removeClass("loading"))})},n.dumply.showAnrDetail=function(n){var i=n&&"id"===n.by?"anr/getDetailById.do":"anr/getRecentDetail.do",r=n&&"id"===n.by?{id:n.id,appId:n.appId}:{queryAnrInfo:JSON.stringify(n)};t.ajax(i,{data:r}).then(function(i){i&&i.success?requirejs(["moment"],function(a){var r=i.data.object;for(var s in r)if(r.hasOwnProperty(s)){var o=r[s];s.indexOf("Time")>=0&&(o=a(o).format("YYYY-MM-DD HH:mm:ss")),t("#anr_"+s).text(o)}t("#anrAnrTime").text(a(r.anrTime).format("YYYY-MM-DD HH:mm:ss")),t("#anrInsertTime").text(a(r.insertTime).format("YYYY-MM-DD HH:mm:ss")),"iPhone OS"!==r.os&&"watchOS"!==r.os||(t(".ios-modify-IMEI").text("设备 ID"),t(".ios-modify-SD").text("磁盘可用占比"),t("#crash_imei").hide(),t("#anr_availSdSize").parent().hide(),t("div.tvhd li[data-tab-index=sys-log]").hide(),t("div.tvhd li[data-tab-index=anr-trace]").hide(),t("div.tvhd li[data-tab-index=anr-message]").hide(),t("div.tvhd li[data-tab-index=user-param]").text("其它信息"),t("span.changeTextAnr:visible").text("卡顿"));var d=t("#dumpStackTpl").text(),p=r.logContent&&r.logContent.split("\n")||[],l=r.userLog&&r.userLog.split("\n")||[],c=r.userParam&&r.userParam.split("\n")||[],u=r.sysLog&&r.sysLog.split("\n")||[],m=r.threadInfo&&r.threadInfo.split("\n")||[],h=r.anrTrace&&r.anrTrace.split("\n")||[],f=r.anrMessage&&r.anrMessage.split("\n")||[],v=e.template(d);t("#dumpStackFull").html(v(p)),t("#userLogList").html(v(l)),t("#userParamList").html(v(c)),t("#sysLogList").html(v(u)),t("#threadInfoList").html(v(m)),t("#anrTraceList").html(v(h)),t("#anrMessageList").html(v(f)),t("div.panelbd").removeClass("loading");var y=t("[data-type-id]").data("typeId"),g={data:{exceptionSolution:JSON.stringify({exceptionTypeId:y,appId:n.appId,type:"anr"})}};t.ajax("solution/count.do",g).then(function(e){if(e&&e.success){var a=e.data.count||0,i=a>0?a+"条解决方案":"我有解决方案",r="#dumply/solution/"+(a>0?"read":"input")+"/#!type=anr&exceptionTypeId="+y+"&offset="+n.offset+"&appId="+n.appId;t("#anrDetailCtn").find("a.btn-solution").text(i).attr("href",r).removeClass("hidden").toggleClass("offer-solution",0>=a)}})}):(a.showAjaxError(i),t("div.panelbd").removeClass("loading"))})},n.dumply.showAnrTrend=function(e){e=e?e:{};var a=[],i=t("#trendContainer").find(".tvbd li.anr-trend");i.find(".version-list li.checked").each(function(e,n){var i=t(n).data("optionIndex");""!=i&&("0.0"===i&&1==t(n).data("allVersion")?a.push(""):a.push(i.toString()))});var r=i.find("input[name=period]"),s="",o="";if("custom"===r.val()){var d=r.parent("label").next().find(".selected-ctn").text().split(" to ");s=d[0],o=d[1]}var p={type:"POST",data:{appId:e.appId||MAS.User.currentApp.appId,version:e.version||a.length>0&&JSON.stringify(a)||JSON.stringify([""]),time:r.val(),startDate:s,endDate:o}},l={dataUrl:"anr/trend.do",time:p.data.time,ajaxParam:t.extend(!0,{},p,{data:{chartType:i.find(".anr-number a.act").data("chartType")}}),chartContainer:i.find(".anr-num-chart")[0],showLegend:!0};n.dumply.showTrendChart(l)},n.dumply.showTrend=function(e){e=e?e:{};var a=[],i=t("#trendContainer").find(".tvbd li.crash-trend");i.find(".version-list li.checked").each(function(e,n){var i=t(n).data("optionIndex");""!=i&&("0.0"===i&&1==t(n).data("allVersion")?a.push(""):a.push(i.toString()))});var r=i.find("input[name=period]"),s="",o="";if("custom"===r.val()){var d=r.parent("label").next().find(".selected-ctn").text().split(" to ");s=d[0],o=d[1]}var p={type:"POST",data:{appId:e.appId||MAS.User.currentApp.appId,version:e.version||a.length>0&&JSON.stringify(a)||JSON.stringify([""]),time:r.val(),startDate:s,endDate:o}},l={dataUrl:"crash/getcrashtrend.do",time:p.data.time,ajaxParam:t.extend(!0,{},p,{data:{chartType:i.find(".crash-number a.act").data("chartType")}}),chartContainer:i.find(".crash-num-chart")[0],showLegend:!0};n.dumply.showTrendChart(l);var c={dataUrl:"crash/querycrashtimetrend.do",time:p.data.time,ajaxParam:t.extend(!0,{},p,{data:{runTime:t(".crash-time a.act").data("runTime")}}),chartContainer:t(".crash-time-chart")[0],showLegend:!0};n.dumply.showTrendChart(c)},n.dumply.showTrendChart=function(t){var e={};e.period=t.time,e.startDate=t.startDate||"",e.endDate=t.endDate||"",e.tooltipFormatter=t.tooltipFormatter||void 0,e.showLegend=t.showLegend||!1,a.drawLineChart(t.chartContainer,t.dataUrl,t.ajaxParam,e)},n.dumply.showVersionList=function(){require(["doT"],function(e){var a=e.template(t("#version-managerTabTpl").text()),n=parseInt(t("input[name=enable].hidden").val());n=t.isNumeric(n)?n:1;var i={type:"POST",data:{queryVersionInfo:JSON.stringify({appId:MAS.User.currentApp.appId,enable:n})}};t.ajax("version/querylist.do",i).then(function(e){e&&e.success&&requirejs(["moment"],function(i){var r=e.data&&e.data.list||[];r.forEach(function(t){t.createTime=i(t.createTime).format("YYYY-MM-DD HH:mm:ss"),t.symbolUpdateTime=t.symbolUpdateTime?i(t.symbolUpdateTime).format("YYYY-MM-DD HH:mm:ss"):"",t.mappingUpdateTime=t.mappingUpdateTime?i(t.mappingUpdateTime).format("YYYY-MM-DD HH:mm:ss"):""});var s={};s.enable=n,s.versionList=r,s.currentApp=MAS.User.currentApp,t("#versionManagerContainer").html(a(s))})})})},n.dumply.filterLog=function(){var e={verbose:0,debug:1,info:2,warn:3,error:4},a=t(".log-filter .m-select3:visible"),n=a.find("input[name=logLevel]"),i=n.val(),r=n.parents(".log-filter").next();"verbose"===i?r.find("li").show():r.find("li").hide().filter(function(a,n){return e[t(n).attr("class")]>=e[i]}).show();var s=t("input[name=filterText]:visible"),o=s.val().toLowerCase();r.find("li:visible").each(function(e,a){t(a).text().toLowerCase().indexOf(o)<=-1&&t(a).hide()})},n});